<!doctype html>
<html lang="en">
  <head>
    <title> CMUS Remote </title>
    <style>
      /* normalize.css */
      html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}template,[hidden]{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit}b,strong{font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:0.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,select,textarea{font:inherit;margin:0}optgroup{font-weight:bold}button,input{overflow:visible}button,select{text-transform:none}button,html [type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid #c0c0c0;margin:0 2px;padding:0.35em 0.625em 0.75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-cancel-button,[type="search"]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:0.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}
    </style>
  </head>
  <body>
    <div class="container">
      <h2 class="title"></h2>

      <dl>
        <dt>Playback<dt>
        <dd class="playback"></dd>

        <dt>Artist<dt>
        <dd class="artist"></dd>

        <dt>Album<dt>
        <dd class="album"></dd>
      </dl>

      <div id="controls">
        <a href="" data-action="player-prev">Prev</a>
        <a href="" data-action="player-pause">Play/Pause</a>
        <a href="" data-action="player-next">Next</a>
      </div>
    </div>

    <script>
      // https://github.com/KyleAMathews/deepmerge
      // Copyright (c) 2012 Nicholas Fisher - MIT License
      function merge(target, src) {
        var array = Array.isArray(src);
        var dest = array && [] || {};

        if (array) {
            target = target || [];
            dest = dest.concat(target);
            src.forEach(function(e, i) {
                if (typeof dest[i] === 'undefined') {
                    dest[i] = e;
                } else if (typeof e === 'object') {
                    dest[i] = merge(target[i], e);
                } else {
                    if (target.indexOf(e) === -1) {
                        dest.push(e);
                    }
                }
            });
        } else {
            if (target && typeof target === 'object') {
                Object.keys(target).forEach(function (key) {
                    dest[key] = target[key];
                })
            }
            Object.keys(src).forEach(function (key) {
                if (typeof src[key] !== 'object' || !src[key]) {
                    dest[key] = src[key];
                }
                else {
                    if (!target[key]) {
                        dest[key] = src[key];
                    } else {
                        dest[key] = merge(target[key], src[key]);
                    }
                }
            });
        }

        return dest;
      }
    </script>

    <script>
      // a redux-like dispatching data store
      function createStore(reducer, initialState) {
        var state = initialState,
            listeners = [];

        function dispatch(action) {
          state = reducer(state, action);
          listeners.forEach(function(callback) { callback(); });
        }

        function subscribe(callback) {
          listeners.push(callback);
        }

        function getState() {
          return state;
        }

        return {
          dispatch: dispatch,
          subscribe: subscribe,
          getState: getState
        };
      };
    </script>

    <script>
      // a reducer action to create a new state, given old state and an action
      function reducer(state, action) {
        switch (action.type) {
          case "patch":
            return merge(Object.assign({}, state), action.data);
        }

        return state;
      }
    </script>

    <script>
      var ENDPOINT = "ws://" + window.location.host + "/ws",
          TIMEOUT_CLOSE = 4000;

      var store = createStore(reducer, { tags: {}, settings: {} });

      var socket = null;

      var slice = Array.prototype.slice,
          isArray = Array.isArray;

      var title = document.querySelector(".title"),
          artist = document.querySelector(".artist"),
          playback = document.querySelector(".playback"),
          album = document.querySelector(".album");

      function time(p, d) {
        function pad(s) { return ("00" + s).slice(-2); }
        function format(t) { return `${pad(Math.floor(t / 60))}:${pad(t % 60)}`; }
        return `${format(p)} / ${format(d)}`
      }

      function render() {
        var data = store.getState();

        title.innerHTML = data.tags.title;
        artist.innerHTML = data.tags.artist;
        album.innerHTML = data.tags.album;
        playback.innerHTML = time(data.position || 0, data.duration);
      }

      store.subscribe(render);

      function command(action) {
        var payload = JSON.stringify({
          command: action,
        })

        socket.send(payload);
      }

      function connect() {
        var timeout;

        if (socket != null) {
          // existing socket present, disconnect it
          socket.close(TIMEOUT_CLOSE);
        }

        socket = new WebSocket(ENDPOINT);

        timeout = setTimeout(function() {
          socket.close(TIMEOUT_CLOSE, "timeout");
        }, 5000);

        socket.addEventListener("open", onOpen(timeout));
        socket.addEventListener("close", onClose(timeout));
      }

      function onClose(timeout) {
        return function(event) {
          clearTimeout(timeout);

          if (event.code == TIMEOUT_CLOSE) {
            connect();
          } else {
            setTimeout(connect, 1000);
          }
        }
      }

      function onOpen(timeout) {
        return function() {
          clearTimeout(timeout);

          socket.addEventListener("message", onMessage);
          socket.addEventListener("error", onError);
        }
      }

      function onMessage(event) {
        var json = JSON.parse(event.data);

        if (json.error) {
          console.error(json.error);
        } else {
          store.dispatch({ type: "patch", data: json });
        }
      }

      function onError(event) {
        console.error("error", event);
      }

      var actions = document.querySelectorAll("a[data-action]")

      document.addEventListener("click", function(event) {
        if (slice.call(actions).indexOf(event.target) >= 0) {
          var action = event.target.attributes["data-action"].value;
          command(action);
          event.preventDefault();
        }
      });

      connect();
    </script>
  </body>
</html>
