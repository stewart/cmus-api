<!doctype html>
<html lang="en">
  <head>
    <title> CMUS Remote </title>
    <style>
      /* normalize.css */
      html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}template,[hidden]{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit}b,strong{font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:0.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,select,textarea{font:inherit;margin:0}optgroup{font-weight:bold}button,input{overflow:visible}button,select{text-transform:none}button,html [type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid #c0c0c0;margin:0 2px;padding:0.35em 0.625em 0.75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}[type="search"]::-webkit-search-cancel-button,[type="search"]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:0.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}

      .container {
        margin: 0 auto;
        padding: 2em 4em;
        max-width: 900px;
      }

      .title {
        margin: 0;
        font-family: "Garamond", "Palantino", "Times New Roman", sans-serif;
        font-size: 60px;
        font-weight: normal;
      }

      .artist, .album {
        margin: 0;
        font-family: "Helvetica Neue", "Helvetica", "Arial", sans-serif;
        font-size: 16px;
      }

      .album {
        margin-top: 5px;
        font-size: 18px;
        font-weight: normal;
      }

      .progress-wrapper {
        margin: 1em 0;
        border-left: 1px solid #888;
        border-right: 1px solid #888;
        height: 15px;
        position: relative;
      }

      .progress-wrapper small {
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translate(-50%);
        font-family: "Garamond", "Palantino", "Times New Roman", sans-serif;
        font-size: 14px;
      }

      .progress-indicator {
        position: absolute;
        top: 50%;
        transform: translate(0, -50%);
        width: 100%;
        height: 1px;
        background: #888;
      }

      .progress-indicator .progress {
        height: 5px;
        position: absolute;
        top: -2px;
        background: #333;
      }

      #controls {
        margin-top: 2em;
        display: flex;
        justify-content: space-around;
      }

      #controls a {
        text-decoration: none;
      }

      #controls svg {
        fill: #222;
        width: 75px;
        height: 75px;
      }
    </style>

    <meta name="viewport" content="width=device-width" />
  </head>
  <body>
    <div class="container">
      <h1 class="title" data-attr="title"></h1>
      <h2 class="artist" data-attr="artist"></h1>
      <h2 class="album" data-attr="album"></h1>

      <div class="progress-wrapper">
        <small data-attr="progress"></small>

        <div class="progress-indicator">
          <div class="progress" data-attr="progress-indicator">
          </div>
        </div>
      </div>

      <div id="controls">
        <a href="" data-action="player-prev">
          <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
            <path d="M1747 141q19-19 32-13t13 32v1472q0 26-13 32t-32-13l-710-710q-9-9-13-19v710q0 26-13 32t-32-13l-710-710q-9-9-13-19v678q0 26-19 45t-45 19h-128q-26 0-45-19t-19-45v-1408q0-26 19-45t45-19h128q26 0 45 19t19 45v678q4-11 13-19l710-710q19-19 32-13t13 32v710q4-11 13-19z"/>
          </svg>
        </a>

        <!-- is dynamically set based on playback state -->
        <a href="" data-attr="playpause" data-action="player-pause"></a>

        <a href="" data-action="player-next">
          <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
            <path d="M45 1651q-19 19-32 13t-13-32v-1472q0-26 13-32t32 13l710 710q8 8 13 19v-710q0-26 13-32t32 13l710 710q8 8 13 19v-678q0-26 19-45t45-19h128q26 0 45 19t19 45v1408q0 26-19 45t-45 19h-128q-26 0-45-19t-19-45v-678q-5 10-13 19l-710 710q-19 19-32 13t-13-32v-710q-5 10-13 19z"/>
          </svg>
        </a>
      </div>
    </div>

    <script>

      // --- deep merge -------------------------------------------------------

      // https://github.com/KyleAMathews/deepmerge
      // Copyright (c) 2012 Nicholas Fisher - MIT License
      function merge(target, src) {
        var array = Array.isArray(src);
        var dest = array && [] || {};

        if (array) {
            target = target || [];
            dest = dest.concat(target);
            src.forEach(function(e, i) {
                if (typeof dest[i] === 'undefined') {
                    dest[i] = e;
                } else if (typeof e === 'object') {
                    dest[i] = merge(target[i], e);
                } else {
                    if (target.indexOf(e) === -1) {
                        dest.push(e);
                    }
                }
            });
        } else {
            if (target && typeof target === 'object') {
                Object.keys(target).forEach(function (key) {
                    dest[key] = target[key];
                })
            }
            Object.keys(src).forEach(function (key) {
                if (typeof src[key] !== 'object' || !src[key]) {
                    dest[key] = src[key];
                }
                else {
                    if (!target[key]) {
                        dest[key] = src[key];
                    } else {
                        dest[key] = merge(target[key], src[key]);
                    }
                }
            });
        }

        return dest;
      }

      // --- store implementation ---------------------------------------------

      function createStore(reducer, initialState) {
        var state = initialState,
            listeners = [];

        function dispatch(action) {
          state = reducer(state, action);
          listeners.forEach(function(callback) { callback(); });
        }

        function subscribe(callback) {
          var isSubscribed = true;

          listeners.push(callback);

          return function unsubscribe() {
            if (!isSubscribed) {
              return;
            }

            var index = listeners.indexOf(callback);

            isSubscribed = false;
            listeners.splice(index, 1);
          }
        }

        function getState() {
          return state;
        }

        return {
          dispatch: dispatch,
          subscribe: subscribe,
          getState: getState
        };
      };

      // --- reducer ----------------------------------------------------------

      function reducer(state, action) {
        switch (action.type) {
          case "patch":
            return merge(Object.assign({}, state), action.data);
        }

        return state;
      }

      // --- Socket -----------------------------------------------------------

      var Socket = (function() {
        function Socket(url) {
          this.url = url;
          this.ws = null;
          this.connected = false;
        }

        Socket.prototype.connect = function() {
        }

        return Socket;
      })();

      // --- renderer ----------------------------------------------------------

      function renderer() {
        var title = document.querySelector("[data-attr=title]"),
            artist = document.querySelector("[data-attr=artist]"),
            album = document.querySelector("[data-attr=album]"),
            progress = document.querySelector("[data-attr=progress]"),
            progressIndicator = document.querySelector("[data-attr=progress-indicator]"),
            playpause = document.querySelector("[data-attr=playpause]");

        var play = `
          <svg width="1792" height="1792" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
            <path d="M1576 927l-1328 738q-23 13-39.5 3t-16.5-36v-1472q0-26 16.5-36t39.5 3l1328 738q23 13 23 31t-23 31z"/>
          </svg>
        `;

        var pause = `
          <svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
            <path d="M1664 192v1408q0 26-19 45t-45 19h-512q-26 0-45-19t-19-45v-1408q0-26 19-45t45-19h512q26 0 45 19t19 45zm-896 0v1408q0 26-19 45t-45 19h-512q-26 0-45-19t-19-45v-1408q0-26 19-45t45-19h512q26 0 45 19t19 45z"/>
          </svg>
        `;

        // time(1, 60) -> "00:01 / 01:00"
        function time(p, d) {
          function pad(s) { return ("00" + s).slice(-2); }

          function format(t) {
            return `${pad(Math.floor(t / 60))}:${pad(t % 60)}`;
          }

          return `${format(p)} / ${format(d)}`
        }

        function draw() {
          var state = store.getState(),
              tags = state.tags;

          window.requestAnimationFrame(function() {
            var width = (state.position / state.duration) * 100;

            if (state.playing) {
              playpause.innerHTML = pause;
            } else {
              playpause.innerHTML = play;
            }

            title.innerHTML = tags.title;
            artist.innerHTML = tags.artist;
            album.innerHTML = tags.album;
            progress.innerHTML = time(state.position || 0, state.duration);
            progressIndicator.setAttribute("style", `width: ${width}%;`)
          });
        }

        return draw;
      }

      // --- main -------------------------------------------------------------

      var ENDPOINT = "ws://" + window.location.host + "/ws",
          TIMEOUT_CLOSE = 4000;

      var store = createStore(reducer, { tags: {}, settings: {} });

      var socket = null;

      var slice = Array.prototype.slice,
          isArray = Array.isArray;

      store.subscribe(renderer());

      function command(action) {
        var payload = JSON.stringify({
          command: action,
        })

        socket.send(payload);
      }

      function connect() {
        var timeout;

        if (socket != null) {
          // existing socket present, disconnect it
          socket.close(TIMEOUT_CLOSE);
        }

        socket = new WebSocket(ENDPOINT);

        timeout = setTimeout(function() {
          socket.close(TIMEOUT_CLOSE, "timeout");
        }, 5000);

        socket.addEventListener("open", onOpen(timeout));
        socket.addEventListener("close", onClose(timeout));
      }

      function onClose(timeout) {
        return function(event) {
          clearTimeout(timeout);

          if (event.code == TIMEOUT_CLOSE) {
            connect();
          } else {
            setTimeout(connect, 1000);
          }
        }
      }

      function onOpen(timeout) {
        return function() {
          clearTimeout(timeout);

          socket.addEventListener("message", onMessage);
          socket.addEventListener("error", onError);
        }
      }

      function onMessage(event) {
        var json = JSON.parse(event.data);

        if (json.error) {
          console.error(json.error);
        } else {
          store.dispatch({ type: "patch", data: json });
        }
      }

      function onError(event) {
        console.error("error", event);
      }

      var actions = document.querySelectorAll("a[data-action]")

      for (var i = 0; i < actions.length; i++) {
        (function() {
          var action = actions[i],
              cmd = action.attributes["data-action"].value;

          action.addEventListener("click", function(event) {
            event.preventDefault();
            command(cmd);
          });
        })()
      }

      connect();
    </script>
  </body>
</html>
